\chapter{Servidor de mapas dinámico}
\label{cap:sevidordemapasdinamico}


En este capítulo se explica la construcción y el funcionamiento del servidor de mapas dinámico. En primer lugar se explica que és, para que se utiliza y como se construye un \textit{costmap}. En segundo lugar se explica como se construyen los mapas que componen el algoritmo y por último se explica como se combinan estos mapas para generar el mapa usado en la navegación.

\section{Costmap\_2D}
\label{sec:costmap2d}
Un \textit{costmap} es una estructura de datos ofrecida por ROS y compuesta por un grid de ocupación y los metadatos de este grid. Cada celda del grid toma valores entre 0 y 255, donde 0 corresponde a una celda vacía, los valores entre 1 y 254 representan la probabilidad de que una celda está ocupada y el valor 255 se reserva para el desconocimiento. Cada valor se asocia con un nivel de gris, como se puede ver en la imagen.
\begin{figure} [hbtp]
  \begin{center}
    \includegraphics[width=7.5cm]{img/cap4/costmap-ejemplo}
  \end{center}
  \caption{Ejemplo visual de un costmap.}
  \label{fig:costmap-ejemplo}
\end{figure}\

Para poder representar la ocupación de un objeto en un \textit{costmap} es necesario hacer uso de las transformadas entre frames que nos ofrece ROS.

\subsubsection{tf}
\label{subsubsec:tf}
Cualquier robot está compuesto por multitud de piezas moviles, como puede ser la propia base del robot o la pinza de un brazo robótico. Cada una de estas piezas se pueden representar con un \textit{frame}. Ademas existen tambien otros \textit{frames} que pueden interesarnos, como puede ser el \textit{frame} de world o el \textit{frame} de map.
\begin{figure} [hbtp]
  \begin{center}
    \includegraphics[width=12cm]{img/cap4/frames}
  \end{center}
  \caption{A la izquierda el frame map y a la derecha los frames de odom y base\_footprint}
  \label{fig:frames}
\end{figure}

Usamos las \textit{tf} para poder representar información relativa a uno de estos frames. Esto puede sernos de utilidad, por ejemplo, si queremos conocer la posición de un objeto que hemos cogido con nuestra pinza respecto a la base de nuestro robot, o cual es la posición relativa de un objeto que estamos percibiendo con el laser respecto a nosotros o respecto al mapa.

Cuando trabajamos con mapas es importante que todo lo que se representa en él sea respecto al frame map. De este modo nuestro mapa puede ser usado por otros nodos, como el nodo de navegación, o en cualquier otro escenario. \pagebreak

\section{Tipos de mapas}

En este apartado se describirá la metodologia seguida para la construcción de cada uno de los tres mapas usados por el algoritmo.

\subsection{Mapa estático}
El mapa estático se caracteriza por incluir las partes inmutables del escenario, como son las paredes o las puertas. La mejor manera de construirlo es medir todo el escenario y crear el mapa usando una herramienta de diseño gráfico. En este caso se ha usado \textit{Gimp}.
Este mapa nos servirá como base para crear el mapa de largo plazo.

\begin{figure} [hbtp]
  \begin{center}
    \includegraphics[width=7cm]{img/cap4/mapaestatico}
  \end{center}
  \caption{Mapa estático}
  \label{fig:mapaestatico}
\end{figure}

\subsection{Mapa de corto plazo}
El mapa de corto plazo se caracteriza por ser un mapa en el que se representa los objetos que el robot va percibiendo. Este mapa se inicializa con el valor 255, lo que indica una incertidumbre total. En el instante en el que el algoritmo de construcción del mapa comienza a iterar comenzarán a corregirse estos valores iniciales, asignando el valor 0 a las celdas que corresponden con zonas libres e incrementando desde 0 hasta 254 el valor de las celdas que se perciben como ocupadas. \pagebreak

\renewcommand{\lstlistingname}{Código}
\begin{lstlisting}[caption=Inicialización del cost\_map correspondiente al mapa de corto plazo, label=initcostmap]

  metadata = getMetadata();
  tf::TransformListener tf(ros::Duration(10));
  cells_size_x = metadata.width;
  cells_size_y = metadata.height;
  resolution = metadata.resolution;
  origin_x = metadata.origin.position.x;
  origin_y = metadata.origin.position.y;
  default_value = 255;
  scan_ready = false;
  pos_ready = false;
  cost_map.resizeMap(cells_size_x,cells_size_y, resolution, origin_x, origin_y);
  cost_map.setDefaultValue(default_value);
  cost_map.resetMap(0,0,cost_map.getSizeInCellsX(), cost_map.getSizeInCellsY());
\end{lstlisting}


El algoritmo propuesto destaca por la capacidad de no solo añadir objetos al mapa, si no ademas eliminarlos si los objetos desaparecen del lugar que ocupaban. Para ello se compara cada muestra de datos con el mapa que estamos generando y si en dicha muestra existen celdas libres que en el mapa están ocupadas se decrementa el valor de dicha celda en el mapa. La cuantia del decremento se puede modelar, consiguiendo asi que el robot olvide más lentamente o más rapidamente los objetos que desaparecen del escenario.\\

\renewcommand{\lstlistingname}{Código}
\begin{lstlisting}[caption=Función principal del nodo. Actualiza el mapa en cada iteración, label=updatecostmap]
  void
  ObstacleDetector::updateCostmap(){
    if(scan_ready && pos_ready){
      incrementCostProcedure();
      decrementCostProcedure();
    }
    pVectorList_.clear();
    pointList_.clear();
  }
\end{lstlisting}

La figura \ref{fig:initserver} fué captada al iniciar el algoritmo. Observamos que la mayor parte del mapa de corto plazo se encuentra en una posición de desconocimiento y que se han ido incluyendo en este las zonas libres, las paredes y la estantería. Los puntos morados y verdes corresponden a la representación de las muestras tomadas por el laser.

\begin{figure}[H]
  \begin{center}
    \subfigure[]{\includegraphics[width=5cm,height=5cm]{img/cap4/incrementmap}}
    \subfigure[]{\includegraphics[width=5cm,height=5cm]{img/cap4/incrementmap2}}
    \subfigure[]{\includegraphics[width=5cm,height=5cm]{img/cap4/incrementmap-rviz}}
  \end{center}
  \caption{Visión del simulador, (a) y (b), y mapa a corto plazo (c).}
  \label{fig:initserver}
\end{figure}

Tras el inicio del algortimo se añadió un objeto nuevo al escenario. Esto se representa en la figura \ref{fig:includeobject}. Vemos como el algoritmo añade el objeto al mapa y lo situa en una posición coherente respecto a la posición que ocupa el objeto en el escenario simulado.

\begin{figure} [H]
  \begin{center}
    \includegraphics[width=6cm,height=5cm]{img/cap4/incrementmap-object3}
    \includegraphics[width=6cm,height=5cm]{img/cap4/incrementmap-object}
  \end{center}
  \caption{Añadimos un objeto al escenario}
  \label{fig:includeobject}
\end{figure}

Una vez que el algoritmo a incluido el objeto en el mapa procedemos a eliminarlo del escenario simulado. Esto se representa en la figura  \ref{fig:deleteobject}. Vemos como el algoritmo ha comenzado a borrar el objeto, por lo que el valor de las celdas que estaban ocupadas por el objeto ahora es mucho menor.

\begin{figure}[H]
  \begin{center}
    \includegraphics[width=6cm,height=5cm]{img/cap4/incrementmap2}
    \includegraphics[width=6cm,height=5cm]{img/cap4/incrementmap-object2}
  \end{center}
  \caption{Eliminamos un objeto del escenario}
  \label{fig:deleteobject}
\end{figure}

El proceso de añadir o eliminar un objeto puede ser más o menos rápido dependiendo de los valores de las varibles que modelan estas operaciones. Para el caso de nuestro algoritmo contamos un fichero con extensión yaml en el que modificamos los valores de los parámetros.
\renewcommand{\lstlistingname}{Código}
\begin{lstlisting}[caption=Fichero de configuración obstacle\_detector.yaml, label=obstacledetectorconfig]
  cost_inc: 4
  cost_dec: 1
  min_lenght: 0.23
  max_lenght: 2.5
\end{lstlisting}
Los valores asociados a cost\_inc y cost\_dec representan el incremento o decremento del valor de una celda por cada iteración del algortimo. Los otros valores configurables representan la longitud máxima y mínima que se tiene en cuenta para cada medida que el laser nos proporciona. Las muestras obtenidas del laser que estén fuera de estos valores son ignoradas.

\subsection{Mapa de largo plazo}
El mapa de largo plazo se inicializa con los valores del mapa estático y se caracteriza por incluir los objetos que tienen un valor muy alto en el mapa de corto plazo, por tanto tenemos un mapa con objetos que han perdurado en el mapa a corto plazo durante un largo periodo de tiempo y que podemos considerar que son objetos estáticos del escenario. 
Este mapa tambien es dinámico, por lo que tambien elimina los objetos del mapa si estos desaparecen del escenario. Para ello se compara el mapa de largo plazo con el mapa de corto plazo. Si una celda en el mapa de largo plazo tiene un valor que indica que está ocupada y en el mapa de corto plazo esa misma celda tiene un valor que indica que está libre, siempre y cuando esa celda no pertenezca a una celda de una pared, se decrementa su valor en el mapa de largo plazo. La cuantia de este decremento tambien puede modelarse, regulando asi la memoria que tenemos de los objetos que hemos añadido a este mapa.\\

{EJEMPLO CODIGO}\\
{EJEMPLO GRAFICO}\\

Adicionalmente este mapa se guarda cada cierto tiempo en un fichero. Asi por ejemplo podemos tener un cuenta una mesa dentro del salón de una casa. Esto nos permitiria planificar una ruta para la navegación en la que podriamos esquivar esta mesa con facilidad y llegar a nuestro destino lo más rápido posible.



\section{Construcción del mapa final}
\label{sec:construccionmap}

